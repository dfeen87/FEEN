<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEEN - AILEE Delta v Metric</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 500;
            color: #00ff9d;
        }
        .param-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .param-input {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #eee;
            padding: 0.5rem;
            border-radius: 4px;
            width: 100%;
        }
        .control-group {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
        }
    </style>
</head>
<body>

    <div class="app-shell">

        <!-- Top navigation bar -->
        <nav class="topbar">
            <div class="topbar-brand">
                <span class="brand-icon">â—ˆ</span>
                <span class="brand-name">FEEN</span>
            </div>
            <div class="topbar-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/simulation" class="nav-link">Simulation</a>
                <a href="/node-graph" class="nav-link">Nodes</a>
                <a href="/coupling" class="nav-link">Coupling</a>
                <a href="/vcp-wiring" class="nav-link">VCP Wiring</a>
                <a href="/ailee-metric" class="nav-link active">AILEE Metrics</a>
                <a href="/docs" class="nav-link">API Reference</a>
            </div>
        </nav>

        <div class="page-content">

            <!-- Page header -->
            <header class="page-header">
                <div class="page-header-text">
                    <h1>AILEE Delta v Metric</h1>
                    <p>Energy-Weighted Optimization Gain Functional</p>
                </div>
                <div class="header-badge">LIVE</div>
            </header>

            <main class="main-grid">

                <!-- Metric Display -->
                <section class="card">
                    <h2 class="card-title">Current Delta v</h2>
                    <div style="text-align: center; padding: 2rem;">
                        <div id="delta-v-display" class="metric-value">0.0000</div>
                        <div style="color: #888; margin-top: 0.5rem;">Optimization Gain</div>
                    </div>
                </section>

                <!-- Configuration -->
                <section class="card">
                    <h2 class="card-title">Parameters</h2>
                    <div class="param-grid">
                        <div>
                            <label>Alpha (Sensitivity)</label>
                            <input type="number" id="param-alpha" class="param-input" value="0.1" step="0.01">
                        </div>
                        <div>
                            <label>Eta (Integrity)</label>
                            <input type="number" id="param-eta" class="param-input" value="1.0" step="0.1">
                        </div>
                        <div>
                            <label>Isp (Efficiency)</label>
                            <input type="number" id="param-isp" class="param-input" value="1.0" step="0.1">
                        </div>
                        <div>
                            <label>v0 (Reference)</label>
                            <input type="number" id="param-v0" class="param-input" value="1.0" step="0.1">
                        </div>
                    </div>
                    <button id="update-config-btn" class="btn btn-primary" style="width: 100%">Update Configuration</button>
                </section>

                <!-- Telemetry Input -->
                <section class="card">
                    <h2 class="card-title">Telemetry Input</h2>
                    <div class="param-grid">
                        <div>
                            <label>Power Input (P)</label>
                            <input type="number" id="input-p" class="param-input" value="1.0">
                        </div>
                        <div>
                            <label>Workload (w)</label>
                            <input type="number" id="input-w" class="param-input" value="0.5">
                        </div>
                        <div>
                            <label>Velocity (v)</label>
                            <input type="number" id="input-v" class="param-input" value="0.8">
                        </div>
                        <div>
                            <label>Mass (M)</label>
                            <input type="number" id="input-m" class="param-input" value="1.0">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="inject-sample-btn" class="btn">Inject Single Sample</button>
                        <button id="auto-sim-btn" class="btn btn-primary">Start Auto-Feed</button>
                    </div>
                </section>

                <!-- Chart -->
                <section class="card chart-card" style="grid-column: span 2;">
                    <h2 class="card-title">Delta v History</h2>
                    <div class="chart-wrap">
                        <canvas id="metricChart"></canvas>
                    </div>
                </section>

            </main>

        </div><!-- /page-content -->

        <footer class="app-footer">
            <span>Powered by FEEN Core (C++17) &amp; AILEE Trust Layer</span>
            <a href="/docs">API Documentation</a>
        </footer>

    </div><!-- /app-shell -->

    <script>
        // Chart Initialization
        const ctx = document.getElementById('metricChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Delta v',
                    data: [],
                    borderColor: '#00ff9d',
                    backgroundColor: 'rgba(0, 255, 157, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false },
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // State
        let isAutoSim = false;
        let simInterval = null;
        let timeStep = 0;

        // API Interactions
        async function updateConfig() {
            const config = {
                alpha: parseFloat(document.getElementById('param-alpha').value),
                eta: parseFloat(document.getElementById('param-eta').value),
                isp: parseFloat(document.getElementById('param-isp').value),
                v0: parseFloat(document.getElementById('param-v0').value)
            };

            await fetch('/api/ailee/metric/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });

            // Reset chart on config change
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.update();
            document.getElementById('delta-v-display').innerText = "0.0000";
        }

        async function injectSample() {
            const sample = {
                p_input: parseFloat(document.getElementById('input-p').value),
                workload: parseFloat(document.getElementById('input-w').value),
                velocity: parseFloat(document.getElementById('input-v').value),
                mass: parseFloat(document.getElementById('input-m').value),
                dt: 0.1
            };

            const response = await fetch('/api/ailee/metric/sample', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(sample)
            });

            const data = await response.json();
            updateDisplay(data.current_delta_v);
        }

        function updateDisplay(value) {
            document.getElementById('delta-v-display').innerText = value.toFixed(4);

            // Update chart
            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(timeStep++);
            chart.data.datasets[0].data.push(value);
            chart.update();
        }

        // Event Listeners
        document.getElementById('update-config-btn').addEventListener('click', updateConfig);
        document.getElementById('inject-sample-btn').addEventListener('click', injectSample);

        document.getElementById('auto-sim-btn').addEventListener('click', () => {
            const btn = document.getElementById('auto-sim-btn');
            if (isAutoSim) {
                clearInterval(simInterval);
                btn.innerText = "Start Auto-Feed";
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-primary');
            } else {
                simInterval = setInterval(() => {
                    // Add independent noise to each input to show dynamic simulation activity
                    const baseV = parseFloat(document.getElementById('input-v').value);
                    const baseP = parseFloat(document.getElementById('input-p').value);
                    const baseW = parseFloat(document.getElementById('input-w').value);

                    document.getElementById('input-v').value = Math.max(0.1, (baseV + (Math.random() - 0.5) * 0.2)).toFixed(2);
                    document.getElementById('input-p').value = Math.max(0.1, (baseP + (Math.random() - 0.5) * 0.1)).toFixed(2);
                    document.getElementById('input-w').value = Math.max(0.1, (baseW + (Math.random() - 0.5) * 0.1)).toFixed(2);

                    injectSample();
                }, 200);
                btn.innerText = "Stop Auto-Feed";
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');
            }
            isAutoSim = !isAutoSim;
        });

        // Initial Config
        updateConfig();
    </script>
</body>
</html>
